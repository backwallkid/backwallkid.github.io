
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>Walter&#39;s Garden</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Walter Huang">
    

    
    <meta name="description" content="关于后端,个人成长,PHP,Python">
<meta property="og:type" content="website">
<meta property="og:title" content="Walter&#39;s Garden">
<meta property="og:url" content="https://backwallkid.github.io/index.html">
<meta property="og:site_name" content="Walter&#39;s Garden">
<meta property="og:description" content="关于后端,个人成长,PHP,Python">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Walter&#39;s Garden">
<meta name="twitter:description" content="关于后端,个人成长,PHP,Python">

    
    <link rel="alternative" href="/atom.xml" title="Walter&#39;s Garden" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/satellite.ico">
    
    
    <link rel="apple-touch-icon" href="/img/rball.png">
    <link rel="apple-touch-icon-precomposed" href="/img/rball.png">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/rball.png" alt="Walter&#39;s Garden" title="Walter&#39;s Garden"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Walter&#39;s Garden">Walter&#39;s Garden</a></h1>
				<h2 class="blog-motto">I love $</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/sitemap.xml">Sitemap</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:backwallkid.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017-06/gitlab_1_virtual_centos_create_gitlab.html" title="向Git前进（一） | 虚拟机创建GitLab" itemprop="url">向Git前进（一） | 虚拟机创建GitLab</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Walter Huang" target="_blank" itemprop="author">Walter Huang</a>
		
  <p class="article-time">
    <time datetime="2017-06-22T12:25:00.000Z" itemprop="datePublished"> Published 2017-06-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p><img src="/images/adam-kool-11868_70c.jpg" alt=""><br><a href="http://unsplash.com/photos/ndN00KmbJ1c" target="_blank" rel="external">Photo</a> by <a href="https://unsplash.com/@adamkool" target="_blank" rel="external">Adam Kool</a> on <a href="https://unsplash.com/" target="_blank" rel="external">Unsplash</a></p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>公司高层内部开会，决定将代码由SVN转移至Git，在公司服务器上搭建GitLab前，先在本地虚拟机的CentOS上实验一遍。</p>
<h3 id="设备"><a href="#设备" class="headerlink" title="设备"></a>设备</h3><p>本地虚拟机为了学习linux所以之前安装过CentOS7.1的镜像，镜像里配置了PHP7和MySql环境。</p>
<h3 id="安装GitLab"><a href="#安装GitLab" class="headerlink" title="安装GitLab"></a>安装GitLab</h3><p>按照GitLab的<a href="https://about.gitlab.com/installation/#centos" target="_blank" rel="external">安装文档</a>，能够成功的完成安装。<br>安装完成图<br><img src="/images/centos7-install-gitlab-complete_wm.png" alt=""><br>笔者在安装完之后找不到入口，仔细查看后发现，GitLab默认是监听80端口的，而之前安装的apache占了80，虽然安装和启动gitlab时没有报错，但是访问80端口会被接引到apache。<br>解决方法是去apache的配置文件httpd.conf中找到Listen 80改为监听其他，再重启服务。apache让出80端口后，访问本机网络地址就能打开GitLab首页了。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>GitLab的配置文件默认位于<code>/etc/gitlab/gitlab.rb</code>，每次改完配置文件，都需要运行<code>gitlab-ctl reconfigure</code>使配置生效。<br>配置文件中有2个参数一定要改：</p>
<ol>
<li>邮箱地址，因为每次创建新用户GitLab都会发邮件到新用户的邮箱，邮件中含有改密码链接。<br>成功创建用户后注意查看收件箱，创建所填写的邮箱会收到来自<a href="&#109;&#x61;&#x69;&#108;&#x74;&#111;&#x3a;&#x67;&#x69;&#116;&#x6c;&#97;&#98;&#64;&#x69;&#x70;&#x5f;&#108;&#111;&#x63;&#97;&#116;&#105;&#111;&#110;">&#x67;&#x69;&#116;&#x6c;&#97;&#98;&#64;&#x69;&#x70;&#x5f;&#108;&#111;&#x63;&#97;&#116;&#105;&#111;&#110;</a>的邮件，可能会出现在垃圾邮件中。<br><img src="/images/gitlab-user-add_wm.png" alt=""></li>
<li>假如虚拟机中安装的GitLab想给主机同一局域网内其他用户或主机使用的话，配置文件中<code>external_url &#39;http://localhost&#39;</code>的localhost必须要改成虚拟机在局域网内ip，改完之后同一局域网内其他用户就能正常访问GitLab了。<br>路径配置前<br><img src="/images/gitlab-externalurl-not-config_wm.png" alt=""><br>路径配置后<br><img src="/images/gitlab-externalurl-config_wm.png" alt=""></li>
</ol>
<p>注：每次reconfigure都会消耗30秒到2分不等的时间。</p>
<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><ol>
<li>先创建组<br><img src="/images/gitlab-group-add_wm.png" alt=""></li>
<li>再创建项目，没有组的话，所有项目都将出现在创建者的用户名下，不方便管理。<br><img src="/images/gitlab-project-add_wm.png" alt=""></li>
<li>按照提示提交文件，其他用户就能pull了。<br><img src="/images/gitlab-repo-inuse_wm.png" alt=""></li>
</ol>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>在虚拟机中一个流程走下来，没有碰到什么坎，GitLab现在产品已经非常成熟了。在找代码就上Github的大环境下，公司做出将项目从SVN陆续迁移至GitLab也是紧跟时代的潮流。</p>
<h3 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h3><p>【预留】向Git前进（二） | GitLab项目开发流程</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://about.gitlab.com/installation/#centos" target="_blank" rel="external">GitLab官方安装文档</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Tech/">Tech</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/GitLab/">GitLab</a><a href="/tags/Linux/">Linux</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017-06/regex-backreference.html" title="正则之反向引用" itemprop="url">正则之反向引用</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Walter Huang" target="_blank" itemprop="author">Walter Huang</a>
		
  <p class="article-time">
    <time datetime="2017-06-14T12:32:00.000Z" itemprop="datePublished"> Published 2017-06-14</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>某日在逛so时，发现侧边栏的Hot Network Questions里有一例<a href="https://codegolf.stackexchange.com" target="_blank" rel="external">codegolf</a>的问题<a href="https://codegolf.stackexchange.com/q/125736" target="_blank" rel="external">Does it repeat?</a>。</p>
<h3 id="挑战"><a href="#挑战" class="headerlink" title="挑战"></a>挑战</h3><p>好奇之下点入观看，该题主的挑战如下：</p>
<blockquote>
<p>当一条字符串中含有2（组/个）连续的字符时，该字符串可以称之为“连续的字符串”。<br>例：2034384538452可以成为“连续的字符串”，因为其含有2次连续的3845。<br>请找出能够判断“连续的字符串”的方法，输入可以用字符串或数组，输入不能为空，并且字符串长度必须大于等于1。<br>题主使用1与0来区分true和false，挑战者也可以使用其他不同的值来区分true/false。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">abcab -&gt; 0</div><div class="line">bdefdefg -&gt; 1</div><div class="line">Hello, World! -&gt; 1</div><div class="line">pp.pp/pp -&gt; 1</div><div class="line">q -&gt; 0</div><div class="line">21020121012021020120210121020121012021012102012021020121012021020120210121020120210201210120210121020121012021020120210121020121012021012102012021020121012021012102012101202102012021012102012021020121012021020120210121020121012021012102012021020121012021020120210121020120210201210120210121020121012021020120210121020120210201210120210201202101210201210120210121020120210201210120210121020121012021020120210121020121012021012102012021020121012021020120210121020120210201210120210121020121012021020120 -&gt; 0</div></pre></td></tr></table></figure></p>
</blockquote>
<h3 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h3><p>所有答者中，大部分常用编程语言的答者都使用正则进行判断，例如：<br><a href="https://codegolf.stackexchange.com/a/125741" target="_blank" rel="external">PHP的解法</a></p>
<blockquote>
<p><code>&lt;?=preg_match(&#39;#(.+)\1#&#39;,$argn);</code></p>
</blockquote>
<p><a href="https://codegolf.stackexchange.com/a/125781" target="_blank" rel="external">Python的解法</a></p>
<blockquote>
<p><code>import re</code><br><code>re.compile(r&#39;(.+)\1&#39;).search</code></p>
</blockquote>
<p><a href="https://codegolf.stackexchange.com/a/125744" target="_blank" rel="external">JavaScript的解法</a></p>
<blockquote>
<p><code>s=&gt;/(.+)\1/.test(s)</code></p>
</blockquote>
<p><a href="https://codegolf.stackexchange.com/a/125752" target="_blank" rel="external">Java的解法</a></p>
<blockquote>
<p><code>a-&gt;a.matches(&quot;.*(.+)\\1.*&quot;)</code></p>
</blockquote>
<p>虽然也有使用循环对比来解答的，但这不是我的关注点。<br>所有正则的解法中，归根结底就是6个字符<code>(.+)\1</code><br><code>.+</code>和<code>()</code>的意思好理解，毕竟是常用的。<code>\1</code>虽然能猜到用途，但是无论如何想不起来是干啥的，进入查询模式。</p>
<h3 id="反向引用（backreference）"><a href="#反向引用（backreference）" class="headerlink" title="反向引用（backreference）"></a>反向引用（backreference）</h3><p>根据<a href="http://www.regexlab.com/zh/regref.htm" target="_blank" rel="external">揭开正则表达式的神秘面纱</a>一文，发现原来正则除了贪婪和非贪婪外还有名为“反向引用”的高级规则。</p>
<blockquote>
<p>表达式在匹配时，表达式引擎会将小括号 “( )” 包含的表达式所匹配到的字符串记录下来。在获取匹配结果的时候，小括号包含的表达式所匹配到的字符串可以单独获取。<br>“\1” 引用第1对括号内匹配到的字符串，”\2” 引用第2对括号内匹配到的字符串……以此类推。<br>如果一对括号内包含另一对括号，则外层的括号先排序号。换句话说，哪一对的左括号 “(“ 在前，那这一对为先。</p>
</blockquote>
<p>在正则<code>(.+)\1</code>中，<code>\1</code>等于<code>(.+)</code>中匹配到的值，也就是连续2次相同的值。</p>
<h3 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h3><p>使用Python进行快速尝试<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">fa</span><span class="params">(regex,subject)</span>:</span></div><div class="line">    <span class="keyword">return</span> re.findall(regex,subject);</div></pre></td></tr></table></figure></p>
<p>匹配出3连的连续字符串<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fa(<span class="string">r'(.+)\1\1'</span>,<span class="string">'d123123123e'</span>);</div><div class="line"><span class="comment">#['123']</span></div><div class="line"></div><div class="line">fa(<span class="string">r'(.+)\1\1'</span>,<span class="string">'d112233e'</span>);</div><div class="line"><span class="comment">#[]</span></div><div class="line"></div><div class="line"><span class="comment">#或</span></div><div class="line">fa(<span class="string">r'((.+))\1\2'</span>,<span class="string">'d123123123e'</span>);</div><div class="line"><span class="comment">#['123']</span></div></pre></td></tr></table></figure></p>
<p>匹配出html标签内的文字<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fa(<span class="string">r'.*&lt;(.+).*?&gt;(.*)&lt;\/\1&gt;.*'</span>,<span class="string">'asdwas&lt;td&gt;ssd&lt;/td&gt;sdasdd'</span>);</div><div class="line"><span class="comment">#[('td', 'ssd')]</span></div><div class="line"></div><div class="line">fa(<span class="string">r'.*&lt;(.+).*?(?:href="(.*?)".*?)?&gt;(.*)&lt;\/\1&gt;.*'</span>,<span class="string">'asdwas&lt;a href="/a/b"&gt;find more&lt;/a&gt;sda'</span>);</div><div class="line"><span class="comment">#[('a', '/a/b','find more')]</span></div><div class="line"></div><div class="line">fa(<span class="string">r'.*&lt;(.+).*?(?:href="(.*?)".*?)?&gt;(.*)&lt;\/\1&gt;.*'</span>,<span class="string">'asdwas&lt;a title="c" href="/a/b" class="on"&gt;find more&lt;/a&gt;sda'</span>);</div><div class="line"><span class="comment">#[('a', '/a/b', 'find more')]</span></div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>反向匹配在业务代码中能用的地方不是很多，假如是纯粹去掉html标签的话，php有<code>strip_tags</code>，python也有对应的<code>stripogram</code>包，简略用法看<a href="http://www.php2python.com/wiki/function.strip-tags/" target="_blank" rel="external">这里</a>。<br>多学一点，在<code>leetcode</code>或<code>codewars</code>这类的刷题网站里以最少的代码量达到要求也能有成就感。<br>在这里挂个我的codewars肩章，欢迎一起来玩儿。<br><a href="https://www.codewars.com" target="_blank" rel="external"><img src="https://www.codewars.com/users/backwallkid/badges/large"></a></p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://codegolf.stackexchange.com/q/125736" target="_blank" rel="external">Does it repeat? - CodeGolf</a><br><a href="http://www.regexlab.com/zh/regref.htm" target="_blank" rel="external">揭开正则表达式的神秘面纱 - regexlab</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Tech/">Tech</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/PHP/">PHP</a><a href="/tags/Python/">Python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017-06/a-php-vote_project.html" title="记一次投票项目" itemprop="url">记一次投票项目</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Walter Huang" target="_blank" itemprop="author">Walter Huang</a>
		
  <p class="article-time">
    <time datetime="2017-06-06T12:32:00.000Z" itemprop="datePublished"> Published 2017-06-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><ol>
<li><a href="#front">项目背景</a></li>
<li><a href="#limits">GithubPages&amp;Heroku limits</a></li>
<li><a href="#beian">工信部备案和公安局备案</a></li>
<li><a href="#dev_start">开发过程</a></li>
<li><a href="#operate">投产过程</a></li>
<li><a href="#sum">总结</a></li>
</ol>
<p></p><h3 id="front">前言</h3><br>　　几周前接到一个亲戚的留言，说是他们公司的工会想做个网页。由于最近朗读者之类的节目比较火，又是临近一个不大不小的节日，于是想做一个可以播放儿童朗诵的投票页面，可以在手机端访问，并且进行投票。<br>　　这家公司人数规模比较大，有上千人，儿童比例也不少。亲戚听说我是做网页的，想拜托我做这个。制作时间只有一周，时间略紧。<p></p>
<h3 id="确定需求"><a href="#确定需求" class="headerlink" title="确定需求"></a>确定需求</h3><p>　　和对方公司工会的秘书沟通后，对方的需求很明确。</p>
<ol>
<li>给了一个有效的网页，样式可以照搬，对于我一个不咋写样式的后端程序员来说可以省下一不少麻烦。</li>
<li>投票时间为3天。</li>
<li>需要限制为lifetime的一人三票，每票必须投给不同的目标。</li>
</ol>
<p>　　但是缺点同样很明显</p>
<ol>
<li>没有服务器，没有域名，没有公众号，不肯出执照。</li>
</ol>
<p>　　于是问题来了，服务器和域名可以在阿里云上面买，阿里云是付费即时到货的，但是现在除了在<strong>通管局备案</strong>外还要进行<strong>公安局备案</strong>，一周的时间不知道够不够。</p>
<p>　　好在我之前学习使用了Github Pages和Heroku于是先写了个demo测试一下备选方案。</p>
<p></p><h3 id="limits">制定备选方案</h3><br>　　Github Pages只能运行html代码，Heroku能运行php代码，阿里云数据库的话，不进行备案也是可以用的。<p></p>
<ul>
<li>在Github Pages上随便搞了个html，请求Heroku上的api，往阿里云数据库里存数据，成功。</li>
<li>Github Pages有每月100G或100,000请求数[?]的带宽限制，由<a href="https://www.quora.com/What-are-bandwidth-and-traffic-limits-for-GitHub-pages" target="_blank" rel="external">此处</a>得知</li>
</ul>
<blockquote>
<p>GitHub Pages sites have a recommended bandwidth limit of <strong>100GB</strong> or <strong>100,000 requests</strong> per month. If your site exceeds that quota, you may receive a polite email from GitHub Support suggesting strategies for reducing your site’s impact on our servers, including moving to a different hosting service that might better fit your needs.</p>
</blockquote>
<p>　　然而在该回答所引用的<a href="https://help.github.com/articles/what-is-github-pages/#usage-limits" target="_blank" rel="external">source</a>中并没有找到关于100,000请求数的限制。</p>
<blockquote>
<p>GitHub Pages source repositories have a recommended limit of 1GB .<br>Published GitHub Pages sites may be no larger than 1 GB.<br>GitHub Pages sites have a soft bandwidth limit of 100GB per month.<br>GitHub Pages sites have a soft limit of 10 builds per hour.</p>
</blockquote>
<ul>
<li>Heroku有每月550h的免费使用时间，没有请求数或带宽限制</li>
<li>使用移动4G和电信wifi下实测demo链接速度，Github Pages比Heroku用时少得多。</li>
</ul>
<p>　　综合上面得出备选方案</p>
<ol>
<li>Github Pages(html)+Heroku(php)+aliyun数据库(MySql)</li>
<li>Heroku(html+php)+aliyun数据库(MySql)</li>
</ol>
<p>　　虽然Github Pages的usage limits里没有关于100,000请求数的限制描述，宁可信其有不可信其无。<br>　　鉴于客户的使用人群广大（该公司员工数上千，朋友圈一发分分钟破万），决定若一周时间无法通过两次备案则使用2号备选方案。</p>
<h3 id="检查需要的素材"><a href="#检查需要的素材" class="headerlink" title="检查需要的素材"></a>检查需要的素材</h3><ol>
<li>网页样式已有，经过测试，该样式适用于大部分常用手机内置浏览器和微信浏览器。</li>
<li>该网页内使用的是audio标签，js控制载入所播放的mp3文件地址。<br>2.1 通过<a href="http://caniuse.com/#search=audio" target="_blank" rel="external">caniuse audio</a>可得该标签被除Opera Mini外所有浏览器支持。<br>2.2 通过<a href="http://caniuse.com/#search=mp3" target="_blank" rel="external">caniuse mp3</a>可得mp3格式的音频文件被除Opera Mini外所有浏览器支持。</li>
<li>投稿图片需切成4:3的大小，使用ps切一下图也用不了很多时间。</li>
</ol>
<h3 id="告知客户既定事项"><a href="#告知客户既定事项" class="headerlink" title="告知客户既定事项"></a>告知客户既定事项</h3><p>　　接下来就是把一些事项和客户工会的秘书罗列清楚，假如他们都可以接受，再进行开发。</p>
<ul>
<li>声明网页访问速度可能会比较慢（一周的时间比较紧张，如果备案过不了审，则需要用备选2号）。</li>
<li>每份投稿必须包含一张图片和一个mp3音频，音频长度不得超过4分钟。</li>
<li>由于网页内图片显示的合适高宽比是4:3，对于一般的照片会进行裁剪。</li>
<li>非mp3格式的文件会被转为mp3格式，假如转换后无法播放，则需要重新提供文件。</li>
<li>音频会进行码率和采样率的压缩，所以音质会有所下降。</li>
<li>由于开发周期较短，所以这些事项确定后，不能再变了。</li>
<li>投产前一日会提供测试链接，并于测试通过后，提供一枚特别定制的二维码与正式链接以供投放。</li>
<li>项目结束当天，会提供所有参赛者以及相应票数的excel表。</li>
</ul>
<h3 id="网站资源"><a href="#网站资源" class="headerlink" title="网站资源"></a>网站资源</h3><h4 id="网站空间"><a href="#网站空间" class="headerlink" title="网站空间"></a>网站空间</h4><p>　　<a href="https://wanwang.aliyun.com/" target="_blank" rel="external">购买</a>域名、<a href="https://www.aliyun.com/easybuy" target="_blank" rel="external">租</a>服务器，上阿里巴巴都能快速搞定，支付宝扫一扫付钱，域名和服务器即时到帐。<br>　　由于这次时间较紧，我没有买云ECS而是买了预装PHP+MySQL环境的独享虚拟机，这里有个<strong>坑</strong>需要了解</p>
<ol>
<li>云服务器ECS：买完给一个空的linux或windows环境（可选），用yum或其他什么装软件，自己配置运行环境，可以使用putty远程连接。底配1核1G1Mbps40G云盘空间可选系统一个月68块，一年8.5折693.6块。</li>
<li>云虚拟主机：买完给个虚拟主机，环境都搭配好了，只有网页上的控制面板，给有限的PHP5.1～5.5环境选择，MySql只有5.1没得选，php.ini只给了有限的几个选项，可以随意删除<code>/tmp</code>目录（session的保存目录）下的和<code>/dev/home/username/htdocs</code>目录下的文件。底配1核1G1Mbps5G网页空间500M数据库一年298块。</li>
</ol>
<p></p><h3 id="beian">工信部备案</h3><br>　　新买的域名都要先去<a href="http://www.miitbeian.gov.cn/" target="_blank" rel="external">工信部备案</a>，跟着流程一步步走。<br>　　由于我是在阿里云上买的域名和服务器，工信部备案可委托阿里云进行（这也是我选择阿里云的一个理由）。<br>　　只要打印一张委托书，打印出来填上姓名日期拍个照，剩下交给阿里云。<br>　　备案审核通过后，预留的手机号会收到【工信部备案系统】发来的短信通知，邮箱也会收到【阿里云备案】发来的《通管局审核通过》邮件。<p></p>
<blockquote>
<p>工信部备案审核通过（收到短信和邮件）后需要约1日的时间，才能在<a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank" rel="external">工信部查询网</a>上查到。</p>
</blockquote>
<p>　　必须要确保能够在<a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank" rel="external">工信部查询网</a>上查到自己的备案号，才能进行公安局网站备案，查不到的话即使提交了备案也会被驳回。<br>　　这一步操作我用了3天（包括一个周末），不知道是不是委托了阿里云的关系。</p>
<h4 id="公安局备案"><a href="#公安局备案" class="headerlink" title="公安局备案"></a>公安局备案</h4><p>　　根据公安局的一个通知，所有的网站必须在当地公安局进行网站备案，上海的通知长<a href="https://help.aliyun.com/noticelist/articleid/13464849.html" target="_blank" rel="external">这样</a>。<br>　　<a href="http://www.beian.gov.cn" target="_blank" rel="external">公安局备案</a>得自己来搞，分为两步。</p>
<ol>
<li>第一步，增加开办主体，这里有个需要<strong>注意</strong>的地方，常住地址一定要写<strong>常住</strong>地址，按照实际情况填写，不一定必须是户口所在地址，公安局的信息都是联网的，这个信息自己斟酌。</li>
<li>第二步，新办网站申请，这里有用到通管局给的备案号，必须要能够在<a href="http://www.miitbeian.gov.cn/publish/query/indexFirst.action" target="_blank" rel="external">工信部查询网</a>上查到自己的备案号后，再填写。</li>
</ol>
<ul>
<li>有些信息，比如服务器存放物理地址、域名注册服务商、接入方式等，可以下阿里云的<strong>工单</strong>，阿里云工程师回复得特别迅速，一般2小时内就有解答。</li>
<li>另外上海的公安局备案流程可能和其他地儿有些不同，第一次提交会被驳回，然后给个qq号，加群以后要填一个excel表，单独发给群主，再提交。信息都对的话，就能通过了。</li>
</ul>
<p>　　这一步我用了2天，其中第一步主体审核可以和工信部备案一起做，互不影响。公安局审批还是挺迅速的，一般提交后过个把小时，就能收到通过或拒绝的短信通知。</p>
<p></p><h3 id="dev_start">开始开发</h3><p></p>
<h4 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h4><p>　　网页样式这块直接拉过来就能用，唯一需要变动的是页首的图片背景，对彩色渐变文字以及一些小图标进行替换 小图标可以上<a href="https://www.iconfinder.com/" target="_blank" rel="external">iconfinder</a>找，有免费使用的。</p>
<h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><p>　　终于用上了我<a href="https://github.com/backwallkid/common-functions/" target="_blank" rel="external">自己造</a>的api根文件和db类。<br>　　由于客户要求要将投票方限制为个人，却又没有微信公众号，而且不允许增加短信验证和图形验证，说是怕影响参与人数。无奈下只能进行IP限制，将私有地址和广播地址进行排除。以防万一顺便加了个自定义ip地址排除。</p>
<h4 id="投稿图片裁切"><a href="#投稿图片裁切" class="headerlink" title="投稿图片裁切"></a>投稿图片裁切</h4><p>　　客户发过来的照片需要按照4:3的大小把脸切出来，使用PS的矩形工具(U)固定大小、自由变换Ctrl+T、按比例缩放Shift+拖、裁剪工具(C)、调整图像大小Alt+Ctrl+I，对某些倾斜的照片摆正后使用仿制图章工具(S)进行修复等操作。五十多张图切下来，对PS的快捷键有了大致的了解。</p>
<h4 id="音频压制"><a href="#音频压制" class="headerlink" title="音频压制"></a>音频压制</h4><p>　　之前想着这个音频随便一压，就用<a href="http://www.pcfreetime.com/formatfactory/CN/index.html" target="_blank" rel="external">格式工厂</a>（FormatFactory，简称FF），没想到在客户发来的音频各种各样格式都有，有些格式的音频被FF转压过以后会缺斤少两。<br>　　犹豫间想到了大学时压片用的<a href="https://sourceforge.net/projects/megui/" target="_blank" rel="external">MeGUI</a>（下称MG），凭借记忆，稍微配置了一下。经测，针对同一个音频进行mp3转换并压缩，MG压制的速度和FF差不多且不会缺斤少两。MG可以将音频码率压到8bit，而FF只能压16bit。</p>
<h4 id="微信跳转"><a href="#微信跳转" class="headerlink" title="微信跳转"></a>微信跳转</h4><p>　　开发过程中用到微信扫一扫进行测试，发现会先进入蓝色感叹号页面，进行站内跳转也会先显示蓝色感叹号。按照页面内提示，提交了通管局的备案号，约2天后，蓝色感叹号页面便不出现了。</p>
<p></p><h3 id="operate">投产</h3><br>　　投产前一日，将一个测试地址发给客户秘书，客户内部查看样式并进行微调。<br>　　当晚，清表清tmp，将带宽提升到7M。客户秘书告知将于约定日的上午八点半进行二维码与链接的投放。<br>　　约定日当天，上午八点半，带宽用量飙升，又加了2M，提到9M。经观测没有再出现破峰值。<br><img src="/images/vote_bw_til1547_wm.png" alt="阿里云控制器用量截图"><br>图为投产日下午阿里云控制器显示的用量截图。<p></p>
<h4 id="增加带宽的坑"><a href="#增加带宽的坑" class="headerlink" title="增加带宽的坑"></a>增加带宽的坑</h4><p>　　阿里云虚拟机增加带宽有个<strong>坑</strong>，如下表所示。</p>
<table>
<thead>
<tr>
<th style="text-align:center">M数</th>
<th style="text-align:center">月数</th>
<th style="text-align:center">页面显示应付金额</th>
<th style="text-align:center">按25/M/月计算应为</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">25</td>
<td style="text-align:center">25</td>
</tr>
<tr>
<td style="text-align:center"><font color="green">2</font></td>
<td style="text-align:center">1</td>
<td style="text-align:center"><font color="green">50</font></td>
<td style="text-align:center">50</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">1</td>
<td style="text-align:center"><font color="red">79</font></td>
<td style="text-align:center">75</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">1</td>
<td style="text-align:center">179</td>
<td style="text-align:center">100</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">1</td>
<td style="text-align:center">279</td>
<td style="text-align:center">125</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">2</td>
<td style="text-align:center">50</td>
<td style="text-align:center">50</td>
</tr>
<tr>
<td style="text-align:center"><font color="green">2</font></td>
<td style="text-align:center">2</td>
<td style="text-align:center"><font color="green">100</font></td>
<td style="text-align:center">100</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">2</td>
<td style="text-align:center">175</td>
<td style="text-align:center">150</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">2</td>
<td style="text-align:center">358</td>
<td style="text-align:center">200</td>
</tr>
<tr>
<td style="text-align:center"><font color="green">2</font></td>
<td style="text-align:center">3</td>
<td style="text-align:center"><font color="green">150</font></td>
<td style="text-align:center">150</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">237</td>
<td style="text-align:center">225</td>
</tr>
<tr>
<td style="text-align:center"><font color="green">2</font></td>
<td style="text-align:center">4</td>
<td style="text-align:center"><font color="green">200</font></td>
<td style="text-align:center">200</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">4</td>
<td style="text-align:center">316</td>
<td style="text-align:center">300</td>
</tr>
</tbody>
</table>
<p>　　由此表可得，假如要买带宽，每次2M的买比较划算，经实测一天至少可连买4次。由于业务用量已够，也没有测试更多的购买量。</p>
<h4 id="刷票封禁"><a href="#刷票封禁" class="headerlink" title="刷票封禁"></a>刷票封禁</h4><p>　　因为客户这个不准那个不准，在投放当日的10点多果然出事了。有一名参赛者的票数异军突起，高出第二名800多票。经过查看记录，有600多票是在近20分钟内投出的，显示的来源IP均不同，且IP为正常值，符合先前制定的规则。在做表的时，抓取了投票请求的请求头，经过分析发现了不同。</p>
<table>
<thead>
<tr>
<th style="text-align:center">\</th>
<th style="text-align:center">正常请求值</th>
<th style="text-align:center">刷票请求值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$_SERVER[‘HTTP_ORIGIN’]</td>
<td style="text-align:center"><code>&#39;http://www.xxx.com&#39;</code></td>
<td style="text-align:center"><code>&#39;&#39;</code></td>
</tr>
<tr>
<td style="text-align:center">getallheaders()[‘Origin’]</td>
<td style="text-align:center"><code>&#39;http://www.xxx.com&#39;</code></td>
<td style="text-align:center"><code>2</code></td>
</tr>
</tbody>
</table>
<p>　　发现问题后，和客户进行了沟通，客户协商后决定将刷票方的票数退回，并由客户方领导对享受刷票的参赛者进行口头劝诫。<br>　　虽然出现了刷票问题，客户也表示不需要增加限制，但是还是对这一现象增加了代码限制。<br>　　之后直到投票结束，没有发现其他的突发情况。</p>
<h3 id="项目结束"><a href="#项目结束" class="headerlink" title="项目结束"></a>项目结束</h3><p>　　项目结束当天早上，导出以票数为排序的参赛选手excel表发给客户秘书。</p>
<p></p><h3 id="sum">总结</h3><br>　　经过这次完成的这个完整的项目，归纳下来制作一个项目需要的能力和资源有<p></p>
<ul>
<li>网站，域名（硬件）</li>
<li>创意或者借鉴能力（设计师）</li>
<li>基本PS制图能力（美工）</li>
<li>根据项目的需要，一些其他的技术，比如这个项目中用到了压片技术（技术，杂项）</li>
<li>沟通，接单前和客户方代表的需求了解，分析（AC，PM）</li>
<li>应变，监控票数，根据已遭遇的刷票手段尽快的给出解决方案（技术，经验）</li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.quora.com/What-are-bandwidth-and-traffic-limits-for-GitHub-pages" target="_blank" rel="external">What are bandwidth and traffic limits for GitHub pages? - quora</a><br><a href="https://help.github.com/articles/what-is-github-pages/" target="_blank" rel="external">What is GitHub Pages? - github</a><br><a href="https://bbs.aliyun.com/read/286714.html" target="_blank" rel="external">为你揭开阿里云公安备案的神秘面纱！申请到成功历时22小时 - 阿里云开发者论坛</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Tech/">Tech</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/PHP/">PHP</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017-05/bc-copy-chinese-not-encoding.html" title="记一次小型生产事故 | BeyondComper跨编码方式复制文件内容" itemprop="url">记一次小型生产事故 | BeyondComper跨编码方式复制文件内容</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Walter Huang" target="_blank" itemprop="author">Walter Huang</a>
		
  <p class="article-time">
    <time datetime="2017-05-25T12:25:00.000Z" itemprop="datePublished"> Published 2017-05-25</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>今天组长在做站内巡检的时候，发现header内有一条meta标签的content显示为乱码。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">"�����򰮶����������򰮶������������������ϰ������أ�����������Դ���Ƚ����ա���ѧ�䷽���ϸ��ʿأ���������й����Ƚ�ˮƽ�����ʺ��й������Ĳ�Ʒ��ʼ�������Ա���������������ġ�"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们版本是由svn控制的，组长使用<em>blame</em>看见是我提交的文件，就丢给我。<br>虽然已经是2个月前的提交，但是我还是稍微有点印象。<br>那是一次从测试站到正式站的代码合并，使用了<strong>BeyondCompare</strong>(下文简称为<strong>BC</strong>)的文件夹对比功能，逐个文件进行对比合并。</p>
<h3 id="发现"><a href="#发现" class="headerlink" title="发现"></a>发现</h3><p>首先确认了测试站和正式站文件的内容是一样的，而测试站中头部文件的编码方式是<em>UTF-8</em>，而正式站中头部文件的编码方式是<em>GB2312</em>。这让我感到非常奇怪，因为不论是用<em>BC</em>文件拷贝还是<em>IDE</em>的文件创建，都不会出现<em>非UTF-8</em>编码的文件。</p>
<p>追溯查询了上一次提交所有文件的编码方式后发现，<em>非UTF-8</em>编码的文件还有很多。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>于是我打算造个环境测试一下，建了两个空文件夹test1、test2，test1中放入一个随意汉字内容的UTF-8编码test.html。</p>
<ol>
<li>先使用BC的<em>目录复制到右边</em>功能，从test1复制到test2，经查test2/test.html的编码方式还是UTF-8。</li>
<li>清空test2/test.html的内容，并将编码方式改为ansi。</li>
<li>再使用BC的<em>打开文件复制到右边</em>功能，从test1/test.html复制到test2/test.html，汉字复制过去了。<br><img src="/images/bc_chinese_copy_wm.jpg" alt="image"><br>如红框显示，只是文字内容复制过去，编码方式却没有。</li>
</ol>
<h3 id="推测"><a href="#推测" class="headerlink" title="推测"></a>推测</h3><p>于是我推测出2个月前的经过是这样的：<br>在进行文件夹内容合并的时候，我发现正式站文件夹内已经有了一个空的头部文件html。<br>于是我在使用BC进行内容合并的时候不是直接拷贝文件，而是点进文件内复制了内容，却没有看到BC右上角提示的不同的文件编码方式。导致一个GB2312的汉字头部文件进了UTF-8编码的网站。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>去追究谁造的GB2312空头部文件已经没有意义了，组长真正的责难点在于我在复制文字的过程中没有检查编码方式不同，还把这个文件投产了。<br>通过这个生产事故，再次敲响警钟，始终要记得<strong>检查文件编码方式</strong>。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Tech/">Tech</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Html-js-css/">Html+js+css</a><a href="/tags/Tools/">Tools</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017-05/leka-shanghai-map-program.html" title="乐卡上海网点地图制作心得 | 百度地图API使用心得" itemprop="url">乐卡上海网点地图制作心得 | 百度地图API使用心得</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Walter Huang" target="_blank" itemprop="author">Walter Huang</a>
		
  <p class="article-time">
    <time datetime="2017-05-17T12:32:00.000Z" itemprop="datePublished"> Published 2017-05-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>事情的起因是我的爱人喜欢收集一些美丽的乐卡(明信片的一种，正面是美丽壮阔的风景照)。作为一个坚实的后盾自然要支持她！于是我经常借着午休穿梭在大街小巷，凭借乐卡官方提供的<a href="https://site.douban.com/leka/widget/forum/7386134/discussion/613542250/" target="_blank" rel="external">乐卡网点地址</a>进行寻找并取卡。在搜寻过程中，萌生了制作一张基于那些地址的专门戳点地图的想法。<br>期间也看到蚂蚁家制作的<a href="http://bbs.mayitec.cn/tools/lekaMapOnline.html" target="_blank" rel="external">北京乐卡地图</a>使用的是百度地图API，但是该网页仅能运行于PC端，手机打开巨卡。刚好我的<a href="https://backwallkid.github.io/">github博客站</a>最近配置完成了，准备自己也写一个。</p>
<h3 id="材料单"><a href="#材料单" class="headerlink" title="材料单"></a>材料单</h3><ol>
<li><a href="http://lbsyun.baidu.com/" target="_blank" rel="external">百度开放平台</a>账号一个</li>
<li>百度开放平台浏览器端启用了Javascript API的AK一条</li>
<li>一个有效的域名，不乐意花钱买域名和服务器的学生党，推荐用Github Pages</li>
</ol>
<h3 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h3><p>怎么调用API的百度地图的<a href="http://lbsyun.baidu.com/jsdemo.htm#a1_2" target="_blank" rel="external">JSDEMO</a>已经写得很清楚了，哪怕写不来js的人(比如我)对照着demo，也能写完初版。<br>记录一下绊子：</p>
<ol>
<li>本地的测试随便搞个开了Javascript API的AK就能测，但是一旦放到服务器上一定要把AK的Refer白名单设为自己域名。</li>
<li>由于我是在github pages中调用百度地图API，我的github注册也比较晚，被限制了必须使用https协议。在https中调用http的js会报错，好在百度地图开放了免认证的<a href="http://lbsyun.baidu.com/index.php?title=jspopular/guide/introduction#Https_.E8.AF.B4.E6.98.8E" target="_blank" rel="external">https支持</a>。</li>
<li>用来放地图的div的层级必须<strong>直接处于body之下</strong>，就算外面套了一层div也会导致地图显示不出来（初版我只用了1小时就写好了，为了定位这个bug居然也用了1小时QAQ）。</li>
<li>假如将项目放到域名下，用手机测试的时候出现如下弹框，请检查所用AK的<u>应用类型</u>是<strong>浏览器端</strong>并且<u>启用服务</u>勾选了<strong>Javascript API</strong>。<br><img src="/images/lbsyun_key_alert_wm.jpg" alt="image"></li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>虽然心理上我比较倾向于使用谷歌地图API进行制作，但是即使做出来，也不是人人手机上都有特殊工具可以正常访问。<br>最后贴一下我做的<a href="https://backwallkid.github.io/leka/shanghai.html">乐卡上海网点地图</a>，经测ios手机可用，PC限chrome,opera,IE11下运行，使用行政区、商圈、地址进行筛选。</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="http://bbs.mayitec.cn/tools/lekaMapOnline.html" target="_blank" rel="external">蚂蚁家的乐卡北京网点地图</a><br><a href="http://lbsyun.baidu.com/jsdemo.htm" target="_blank" rel="external">百度地图JavaScript API示例DEMO</a><br><a href="http://lbsyun.baidu.com/index.php?title=jspopular/guide/introduction#Https_.E8.AF.B4.E6.98.8E" target="_blank" rel="external">百度地图API的Https说明</a><br><a href="https://help.github.com/articles/what-is-github-pages/" target="_blank" rel="external">what is github pages</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Tech/">Tech</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Html-js-css/">Html+js+css</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017-05/android-wechat-cannot-analysis-gzip-video.html" title="2017年05月10日记一次微项目投产 | 安卓版微信内置浏览器不能解析gzip压缩过的mp4视频的问题" itemprop="url">2017年05月10日记一次微项目投产 | 安卓版微信内置浏览器不能解析gzip压缩过的mp4视频的问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Walter Huang" target="_blank" itemprop="author">Walter Huang</a>
		
  <p class="article-time">
    <time datetime="2017-05-11T12:30:00.000Z" itemprop="datePublished"> Published 2017-05-11</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>今天投产了一个小项目，一个很简单的H5，有播放视频功能，使用了videojs插件。<br>之前也做过数个视频播放，视频的转压都按照既定流程进行，文件放到FTP后，iphone和安卓机测试下来都没有问题。<br>于是给链接，业务组直接在微信公众号里投放了。那个企业号有不少关注的人，推送发出去1分钟就有近千阅读量。<br>但是我在点击链接后，发现项目打不开了，而且该企业官网的主站也挂了，在经过pc端和手机4G下测试发现问题依然存在后，赶紧报bug给其他同事。<br>通过询问FTP管理员得知，那个“大”企业的网站带宽只有10M。假如只是普通H5的话，绰绰有余，但是现在里面有个13m的mp4视频，当然请求量集中飙升的时候，带宽瞬间耗尽。<br>经过多方协商，高层决定使用紧急方案，把视频和其他图片文件放到我们公司的一个cdn服务器上，修改H5内的资源链接，使之直接请求cdn，以缓解那个“大”企业网站带宽不足的问题。<br>前端同事在修改路径后，又发现了新的问题：<br>mp4视频在iphone手机的微信内置浏览器内能够正常播放，而测试用的安卓机均提示不能解析。<br>通过网络搜索，一开始以为是<a href="https://segmentfault.com/q/1010000008880318" target="_blank" rel="external">视频格式的问题</a>，向视频来源确认过后排除了。</p>
<h3 id="用于测试的安卓机型"><a href="#用于测试的安卓机型" class="headerlink" title="用于测试的安卓机型"></a>用于测试的安卓机型</h3><ul>
<li>微信6.5.7 华为P10 PLUS Android 7.0 华为浏览器版本10.7.2.4038<br>微信内置浏览器user agent:<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mozilla/5.0 (Linux; Android 7.0; VKY-AL00 Build/HUAWEIVKY-AL00; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/53.0.2785.49 Mobile MQQBrowser/6.2 TBS/043220 Safari/537.36 MicroMessenger/6.5.7.1041 NetType/WIFI Language/zh_CN</div></pre></td></tr></table></figure>
</li>
</ul>
<p>华为浏览器user agent:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mozilla/5.0 (Linux; Android 7.0; VKY-AL00 Build/HUAWEIVKY-AL00) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30</div></pre></td></tr></table></figure></p>
<ul>
<li>微信6.5.7 三星Galaxy S6 edge+ Android 6.0.1 三星浏览器版本4.0.20-47<br>微信内置浏览器user agent: <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mozilla/5.0 (Linux; Android 6.0.1; SM-G9280 Build/MMB29K; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/53.0.2785.49 Mobile MQQBrowser/6.2 TBS/043220 Safari/537.36 MicroMessenger/6.5.7.1041 NetType/WIFI Language/zh_CN</div></pre></td></tr></table></figure>
</li>
</ul>
<p>三星浏览器user agent:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Mozilla/5.0 (Linux; Android 6.0.1; SAMSUNG SM-G9280 Build/MMB29K) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/4.0 Chrome/44.0.2403.133 Mobile Safari/537.36</div></pre></td></tr></table></figure></p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>以下是问题解决思路</p>
<ol>
<li>同样的视频文件，在该大企业的网站内时，安卓机是可以正常播放的。</li>
<li>而视频文件到了cdn服务器里，安卓机提示不能解析。</li>
<li>使用chrome浏览器的network对比两边请求头 <em>(Request Header)</em> 和响应头 <em>(Response Header)</em> </li>
<li>发现从cdn服务器请求到的mp4视频比大企业的网站内请求到的mp4视频的请求头多了一行<code>Accept-Encoding:gzip, deflate, sdch</code></li>
<li>发现从cdn服务器请求到的mp4视频比大企业的网站内请求到的mp4视频的响应头多了一行<code>Content-Encoding: gzip</code></li>
<li>进行有针对性的进行搜索</li>
</ol>
<p>经过查询发现：</p>
<ul>
<li>4中请求头<code>Accept-Encoding:gzip, deflate, sdch</code>的含义是浏览器告诉服务器，其能够解析的压缩种类是<code>gzip, deflate, sdch</code>；</li>
<li>5中响应头<code>Content-Encoding: gzip</code>的含义是服务器告诉浏览器，其所响应的mp4视频所用的压缩方式是<code>gzip</code>。</li>
<li>cdn服务器会为了提升效率，配置了给输出的mp4视频进行gzip视频流压缩，以达到加速的效果。</li>
<li>微信内置浏览器不支持gzip压缩，详情可见<a href="http://www.qcyoung.com/2015/11/11/%E5%BE%AE%E4%BF%A1%E5%86%85%E7%BD%AE%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8D%E6%94%AF%E6%8C%81gzip%E5%8E%8B%E7%BC%A9%E5%8F%8Agzip%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE%E7%AE%80%E8%BF%B0/" target="_blank" rel="external">此处</a>。</li>
</ul>
<p>接着又测试了一下安卓微信内置浏览器和安卓默认浏览器的视频播放差异，发现视频在华为浏览器内是可以播放的，三星浏览器和微信内置浏览器不行。而该项目的投放主要是在微信中进行，必须要把微信内置浏览器的兼容放在首位。<br>于是联系cdn管理员进行重新配置，关闭mp4的gzip压缩，当响应头内的<code>Content-Encoding: gzip</code>消失时，测试用安卓机的微信内置浏览器也能够播放视频了。</p>
<p>由于正式环境已经正常了而且也没有办法输出信息，于是决定在本地搭模拟环境，自由的获取请求头和响应头以观察区别。</p>
<h3 id="模拟环境"><a href="#模拟环境" class="headerlink" title="模拟环境"></a>模拟环境</h3><p>在本机上模拟了一下环境，将同样的mp4视频放到目录内，apache服务器配置了gzip压缩环境，参照<a href="http://cl314413.blog.163.com/blog/static/190507976201006105628622/" target="_blank" rel="external">此处</a>。<br>打开httpd.conf，将下面两个模块打开。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LoadModule deflate_module modules/mod_deflate.so</div><div class="line">LoadModule headers_module modules/mod_headers.so</div></pre></td></tr></table></figure></p>
<p>在配置文件中写入，配置指令可参考<a href="http://man.chinaunix.net/newsoft/Apache2.2_chinese_manual/mod/mod_mime.html#addoutputfilter" target="_blank" rel="external">Apache模块 mod_mime文档</a>和<a href="http://man.chinaunix.net/newsoft/Apache2.2_chinese_manual/mod/mod_deflate.html#deflatecompressionlevel" target="_blank" rel="external">Apache模块 mod_deflate文档</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;ifmodule mod_deflate.c&gt;</div><div class="line">DeflateCompressionLevel 1</div><div class="line">AddOutputFilter DEFLATE mp4</div><div class="line">&lt;/ifmodule&gt;</div></pre></td></tr></table></figure></p>
<p>建个php，上代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_head</span><span class="params">($szUrl)</span></span>&#123;</div><div class="line">    $curl = curl_init();</div><div class="line">    curl_setopt($curl, CURLOPT_URL, $szUrl);</div><div class="line">    curl_setopt($curl, CURLOPT_HEADER, <span class="number">1</span>);  <span class="comment">//输出header信息</span></div><div class="line">    curl_setopt($curl, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);  <span class="comment">//不显示网页内容</span></div><div class="line">    curl_setopt($curl, CURLOPT_ENCODING, <span class="string">''</span>); <span class="comment">//允许执行gzip</span></div><div class="line">    $data=curl_exec($curl);</div><div class="line">    <span class="keyword">if</span>(!curl_errno($curl))</div><div class="line">    &#123;</div><div class="line">        $info = curl_getinfo($curl);</div><div class="line">        $httpHeaderSize = $info[<span class="string">'header_size'</span>];  <span class="comment">//header字符串体积</span></div><div class="line">        $pHeader = substr($data, <span class="number">0</span>, $httpHeaderSize); <span class="comment">//获得header字符串</span></div><div class="line">        <span class="keyword">return</span> $pHeader;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">return</span> curl_errno($curl);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">$header=get_head(<span class="string">'http://10.*.*.*/video/video.mp4'</span>);</div><div class="line"><span class="meta">?&gt;</span></div><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html lang=<span class="string">"en"</span>&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</div><div class="line">    &lt;title&gt;Video test&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;h4&gt;请求头(Request Header)&lt;/h4&gt;</div><div class="line">&lt;span&gt;HTTP_USER_AGENT:&lt;/span&gt;&amp;nbsp;&amp;nbsp;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>] <span class="meta">?&gt;</span>&lt;br&gt;</div><div class="line">&lt;span&gt;HTTP_ACCEPT_ENCODING:&lt;/span&gt;&amp;nbsp;&amp;nbsp;<span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_SERVER[<span class="string">'HTTP_ACCEPT_ENCODING'</span>] <span class="meta">?&gt;</span></div><div class="line">&lt;h4&gt;响应头(Response Header)&lt;/h4&gt;</div><div class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> str_replace(<span class="keyword">array</span>(<span class="string">"\r\n"</span>,<span class="string">"\r"</span>,<span class="string">"\n"</span>),<span class="string">'&lt;br&gt;'</span>,$header) <span class="meta">?&gt;</span></div><div class="line">&lt;hr&gt;</div><div class="line">&lt;video src=<span class="string">"video.mp4"</span> controls=<span class="string">"controls"</span>&gt;</div><div class="line">    您的浏览器不支持 video 标签。</div><div class="line">&lt;/video&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>使用PC端chrome运行后，页面如下图，同一局域网内手机也能够获取差不多的数据。<br><img src="/images/vt_pc_chrome_wm.jpg" alt="image"><br>同一局域网内华为P10PLUS微信内置浏览器和华为浏览器运行video test的截图如下：<br><img src="/images/vt_hw_comb_wm.jpg" alt="image"><br>三星Galaxy S6 edge+微信内置浏览器和三星默认浏览器运行video test的截图如下：<br><img src="/images/vt_s6_comb_fix_wm.jpg" alt="image"><br>经过详细的测试后，证实了安卓版微信6.5.7内置浏览器不能正确处理gzip压缩过的视频的问题。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>正式环境发现问题，经过本机模拟环境验证，得出的结论是：<br><strong>测试安卓机的微信版本6.5.7的内置浏览器没有正确解压gzip的功能，或者解压gzip功能损坏。</strong><br>该问题仅限于安卓微信版本6.5.7还是其他已经没有办法继续，毕竟公司内能拿来的安卓机都拿来测过了，暂时先写下这么一篇笔记，做个记录。</p>
<p><strong>在微信内置浏览器中播放视频，当iphone可以播放，安卓无法播放时，可以考虑是否是安卓版微信无法正常处理gzip的问题。</strong></p>
<p>同时也总结出一个教训，当投放的内容有占用大带宽(视频)的操作时，要先了解清楚投放网站的带宽，做好备选措施。比如这次事故，假如提前做好调查和上级打好招呼，至少可以省掉部份协商的时间。</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="http://man.chinaunix.net/newsoft/Apache2.2_chinese_manual/mod/directives.html" target="_blank" rel="external">Apache HTTP Server 版本2.2指令索引</a><br><a href="http://cl314413.blog.163.com/blog/static/190507976201006105628622/" target="_blank" rel="external">Apache启用GZIP压缩优化网站</a><br><a href="http://www.qcyoung.com/2015/11/11/%E5%BE%AE%E4%BF%A1%E5%86%85%E7%BD%AE%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8D%E6%94%AF%E6%8C%81gzip%E5%8E%8B%E7%BC%A9%E5%8F%8Agzip%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE%E7%AE%80%E8%BF%B0/" target="_blank" rel="external">微信内置浏览器不支持gzip压缩</a><br><a href="https://seonoco.com/the-difference-between-mod-deflate-and-mod-gzip" target="_blank" rel="external">mod_gzip和mod_deflate的区别</a><br><a href="https://webmasters.stackexchange.com/questions/22217/which-browsers-handle-content-encoding-gzip-and-which-of-them-has-any-special" target="_blank" rel="external">Which browsers handle ‘Content-Encoding: gzip’</a><br><a href="https://imququ.com/post/content-encoding-header-in-http.html" target="_blank" rel="external">HTTP 协议中的 Content-Encoding</a><br><a href="http://stackoverflow.com/questions/864448/how-to-set-content-encoding-with-gzip" target="_blank" rel="external">How to set Content-Encoding with gzip</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Tech/">Tech</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/PHP/">PHP</a><a href="/tags/Apache/">Apache</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







</div>
      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Tech/" title="Tech">Tech<sup>6</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/PHP/" title="PHP">PHP<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Html-js-css/" title="Html+js+css">Html+js+css<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Apache/" title="Apache">Apache<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Tools/" title="Tools">Tools<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/GitLab/" title="GitLab">GitLab<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="http://coolshell.cn/" target="_blank" title="酷壳">酷壳</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.cnblogs.com/waltersgarden/" target="_blank" title="辅站">辅站</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">Weibo</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Walter Huang. <br/>
			This is my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Walter Huang">Walter Huang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?8c349ebad6e132c9cbd08509cd6b0929";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
